<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nightstream wasm demo</title>
    <link rel="icon" href="data:," />
    <link rel="stylesheet" href="./tokens.css" />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <main class="page">
      <header class="header">
        <div class="header-left">
          <h1>Nightstream wasm demo</h1>
          <p class="subtitle">
            Lattice-based folding (neo-fold) with Twist/Shout memory, running in the browser via
            WebAssembly.
          </p>
          <p class="subtitle">
            Paste or load a circuit JSON (R1CS matrices + per-step witness) and run folding
            prove+verify.
          </p>
          <div id="build-line" class="build-line">Build: …</div>
        </div>
        <div class="header-right">
          <a
            class="header-link"
            href="https://github.com/nicarq/nightstream/blob/main/README.md"
            target="_blank"
            rel="noopener noreferrer"
            >Learn more</a
          >
          <a
            class="header-link"
            href="https://github.com/LFDT-Nightstream/Nightstream/"
            target="_blank"
            rel="noopener noreferrer"
            >GitHub repo</a
          >
          <button id="info-btn" class="btn btn-tertiary" type="button">Info</button>
        </div>
      </header>

      <section class="statusbar" aria-label="Status">
        <div class="chip-row">
          <span id="status-bundle" class="chip chip-neutral">Bundle: …</span>
          <span id="status-coi" class="chip chip-neutral">Cross-Origin Isolation: …</span>
          <button id="status-threads" class="chip chip-neutral chip-button" type="button">
            Threads: …
          </button>
          <button id="commit-btn" class="chip chip-neutral chip-button" type="button">
            Commit: …
          </button>
        </div>

        <div id="threads-fix" class="callout callout-warning" hidden>
          <div class="callout-title">Enable COOP/COEP headers to use threads</div>
          <div class="callout-body">
            Your page must be <strong>cross-origin isolated</strong> to enable
            <code>SharedArrayBuffer</code> and wasm threads. Local dev: run <code>./serve.sh</code>.
          </div>
          <div class="codeblock">
            <div class="codeblock-row">
              <div class="codeblock-title">HTTP response headers</div>
              <button id="copy-coi-headers" class="btn btn-tertiary btn-sm" type="button">
                Copy
              </button>
            </div>
            <pre id="coi-headers" class="codeblock-pre"></pre>
          </div>
          <div class="callout-footer">
            Tip: avoid loading JS/CSS from third-party CDNs when using
            <code>Cross-Origin-Embedder-Policy: require-corp</code>.
          </div>
        </div>
      </section>

      <div class="layout">
        <section class="card controlsbar" aria-label="Controls">
          <div class="card-header">
            <h2>Controls</h2>
          </div>

          <div class="controls-grid">
            <div class="controls-col">
              <div class="section-title">Circuits</div>
              <div class="field">
                <label class="label">Input mode</label>
                <select id="input-mode" class="select" aria-label="Input mode">
                  <option value="test_export" selected>TestExport JSON (R1CS + witness)</option>
                  <option value="rv32_fibonacci">RISC-V (RV32 B1) · Fibonacci</option>
                </select>
                <div class="help">
                  RISC-V mode expects a small “mini-asm” subset (or one 32-bit word per line).
                </div>
              </div>
              <div class="preset-row" role="group" aria-label="Preset circuits">
                <button class="btn btn-secondary preset-btn" type="button" data-preset="toy_square">
                  Toy circuit
                </button>
                <button
                  class="btn btn-secondary preset-btn"
                  type="button"
                  data-preset="toy_square_folding_8_steps"
                >
                  Toy folding (8 steps)
                </button>
                <button
                  class="btn btn-secondary preset-btn"
                  type="button"
                  data-preset="poseidon2_ic_batch_1"
                >
                  Poseidon2 IC (batch 1)
                </button>
                <button class="btn btn-secondary preset-btn" type="button" data-preset="rv32_fibonacci">
                  RV32 Fibonacci
                </button>
              </div>

              <div id="json-loader-field" class="field">
                <label class="label">Load JSON</label>
                <div id="file-drop" class="dropzone" tabindex="0" role="button">
                  <div class="dropzone-title">Drag &amp; drop a <code>.json</code> file</div>
                  <div class="dropzone-subtitle">
                    or <span class="dropzone-link">choose a file</span>
                  </div>
                  <input
                    id="file-input"
                    class="dropzone-input"
                    type="file"
                    accept=".json,application/json"
                  />
                </div>
                <div id="file-meta" class="filemeta" hidden>
                  <div>
                    <span id="file-name" class="filemeta-name"></span>
                    <span id="file-size" class="filemeta-size"></span>
                  </div>
                  <button id="file-clear" class="btn btn-tertiary btn-sm" type="button">
                    Clear
                  </button>
                </div>
              </div>
            </div>

            <div class="controls-col">
              <div class="section-title">Options</div>
              <div class="toggle-row">
                <label class="toggle">
                  <input id="compress-spartan" type="checkbox" />
                  <span class="toggle-ui" aria-hidden="true"></span>
                  <span class="toggle-label">
                    Compress with Spartan2 <span class="badge badge-soft">Experimental</span>
                  </span>
                </label>
                <div class="help">
                  Produces a Spartan2 proof from the folding proof (larger wasm + longer runtime).
                </div>
              </div>

              <div id="riscv-options" class="field" hidden>
                <div class="label">RV32 Fibonacci inputs</div>
                <div class="riscv-input-grid" role="group" aria-label="RV32 Fibonacci inputs">
                  <div class="mini-field">
                    <label class="mini-label" for="riscv-n">n</label>
                    <input id="riscv-n" class="select" type="number" min="0" step="1" value="3" />
                  </div>
                  <div class="mini-field">
                    <label class="mini-label" for="riscv-ram-bytes">ram_bytes</label>
                    <input id="riscv-ram-bytes" class="select" type="text" value="0x800" />
                  </div>
                  <div class="mini-field">
                    <label class="mini-label" for="riscv-chunk-size">chunk_size</label>
                    <input id="riscv-chunk-size" class="select" type="number" min="1" step="1" value="128" />
                  </div>
                  <div class="mini-field">
                    <label class="mini-label" for="riscv-max-steps">max_steps</label>
                    <input id="riscv-max-steps" class="select" type="number" min="0" step="1" value="0" />
                  </div>
                </div>
                <div class="help">
                  Inputs: <code>n</code>, <code>ram_bytes</code>, <code>chunk_size</code>,
                  <code>max_steps</code> (0 = default). The guest reads <code>n</code> from RAM[0x104]
                  and must write <code>fib(n)</code> to RAM[0x100] before <code>ecall</code>.
                </div>
              </div>
            </div>

            <div class="controls-col">
              <div class="section-title">Actions</div>
              <div class="actions">
                <button id="run" class="btn btn-primary btn-block" type="button">
                  <span class="btn-label">Prove + Verify</span>
                  <span class="btn-spinner" aria-hidden="true"></span>
                </button>
                <div class="row row-tight actions-subrow">
                  <button id="download-spartan" class="btn btn-secondary" type="button" disabled>
                    Download Spartan SNARK
                  </button>
                  <button id="clear-log" class="btn btn-tertiary" type="button">Clear output</button>
                </div>
                <div id="run-status" class="run-status" aria-live="polite"></div>
              </div>
            </div>
          </div>
        </section>

        <section class="workspace">
          <section class="card">
            <div class="card-header">
              <div class="card-header-left">
                <button
                  id="circuit-json-toggle"
                  class="btn btn-tertiary btn-sm btn-icon btn-disclosure"
                  type="button"
                  aria-expanded="true"
                  aria-controls="circuit-json-body"
                  aria-label="Collapse Circuit JSON"
                  title="Collapse Circuit JSON"
                ></button>
                <h2 id="input-title">Circuit JSON</h2>
              </div>
              <div class="toolbar">
                <button id="json-format" class="btn btn-tertiary btn-sm" type="button">
                  Format
                </button>
                <button id="json-copy" class="btn btn-tertiary btn-sm" type="button">
                  Copy
                </button>
                <button id="json-download" class="btn btn-tertiary btn-sm" type="button">
                  Download
                </button>
                <button id="json-validate" class="btn btn-tertiary btn-sm" type="button">
                  Validate
                </button>
              </div>
            </div>
            <div id="circuit-json-body">
              <div id="json-error" class="banner banner-error" hidden></div>
              <div id="circuit-json-editor" class="editor">
                <div class="editor-inner">
                  <div id="circuit-json-gutter" class="editor-gutter" aria-hidden="true"></div>
                  <textarea
                    id="circuit-json"
                    class="editor-textarea"
                    aria-label="Circuit JSON"
                    spellcheck="false"
                  ></textarea>
                </div>
              </div>
            </div>
          </section>

          <section class="card">
            <div class="card-header">
              <h2>Output</h2>
              <div class="toolbar">
                <label class="toggle toggle-compact">
                  <input id="autoscroll" type="checkbox" />
                  <span class="toggle-ui" aria-hidden="true"></span>
                  <span class="toggle-label">Auto-scroll</span>
                </label>
                <button id="copy-logs" class="btn btn-tertiary btn-sm" type="button">
                  Copy
                </button>
              </div>
            </div>
            <div id="log" class="console" role="log" aria-live="polite"></div>
          </section>
        </section>
      </div>

      <div id="info-panel" class="modal" hidden>
        <div class="modal-backdrop" data-close="true"></div>
        <div class="modal-dialog" role="dialog" aria-modal="true" aria-label="Info">
          <div class="modal-header">
            <div class="modal-title">Info</div>
            <button class="btn btn-tertiary btn-sm" type="button" data-close="true">Close</button>
          </div>
          <div class="modal-body">
            <div class="field">
              <div class="label">Thread verification (paste into DevTools Console)</div>
              <div class="row row-tight">
                <button id="copy-thread-check" class="btn btn-tertiary btn-sm" type="button">
                  Copy
                </button>
                <div id="copy-status" class="small muted"></div>
              </div>
              <textarea
                id="thread-check-command"
                class="code"
                readonly
                rows="2"
                spellcheck="false"
              ></textarea>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module" src="./main.js"></script>
  </body>
</html>
